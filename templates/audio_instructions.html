<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Instructions - {{ recipe.name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container audio-container">
        <!-- Navigation Header -->
        <header class="page-header">
            <a href="/recipe/{{ recipe.id }}" class="back-button">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1>Audio Instructions</h1>
            <a href="/" class="home-button">
                <i class="fas fa-home"></i>
            </a>
        </header>

        <div class="audio-content">
            <div class="recipe-image">
                <img src="{{ recipe.img_url }}" alt="{{ recipe.name }}">
                <h2>{{ recipe.name }}</h2>
            </div>

            <div class="audio-player-container">
                <div class="step-progress">
                    <span id="current-step">Step 1</span>
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                    <span id="total-steps">of {{ recipe.audio_steps|length }} steps</span>
                </div>
                
                <div class="audio-controls">
                    <button id="prev-step" class="control-button">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button id="play-pause" class="control-button play-button">
                        <i class="fas fa-play"></i>
                    </button>
                    <button id="next-step" class="control-button">
                        <i class="fas fa-step-forward"></i>
                    </button>
                </div>
                
                <div class="step-text">
                    <p id="step-instruction">{{ recipe.audio_steps[0].text if recipe.audio_steps }}</p>
                </div>
                
                <!-- Hidden audio element -->
                <audio id="step-audio" style="display: none;"></audio>
            </div>
        </div>
    </div>

    <script>
        const recipeData = {{ recipe|tojson | safe }};
        const audioSteps = recipeData.audio_steps || [];
        
        document.addEventListener('DOMContentLoaded', function() {
            const audioPlayer = document.getElementById('step-audio');
            const playPauseBtn = document.getElementById('play-pause');
            const prevBtn = document.getElementById('prev-step');
            const nextBtn = document.getElementById('next-step');
            const stepInstruction = document.getElementById('step-instruction');
            const currentStepEl = document.getElementById('current-step');
            const progressFill = document.querySelector('.progress-fill');
            
            let currentStepIndex = 0;
            
            function loadStep(index) {
                currentStepIndex = index;
                const step = audioSteps[index];
                
                if (!step) return;
                
                // Update audio source
                audioPlayer.src = step.audio_url;
                console.log(step.audio_url)
                audioPlayer.load();
                
                // Update UI
                stepInstruction.textContent = step.text;
                currentStepEl.textContent = `Step ${index + 1}`;
                document.getElementById('total-steps').textContent = `of ${audioSteps.length} steps`;
                
                // Update progress
                const progressPercent = ((index + 1) / audioSteps.length) * 100;
                progressFill.style.width = `${progressPercent}%`;
                
                // Reset play button
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                playPauseBtn.classList.remove('playing');
            }
            
            // Navigation
            prevBtn.addEventListener('click', function() {
                if (currentStepIndex > 0) {
                    loadStep(currentStepIndex - 1);
                }
            });
            
            nextBtn.addEventListener('click', function() {
                if (currentStepIndex < audioSteps.length - 1) {
                    loadStep(currentStepIndex + 1);
                }
            });
            
            // Play/pause
            playPauseBtn.addEventListener('click', function() {
                if (audioPlayer.paused) {
                    audioPlayer.play();
                    playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    playPauseBtn.classList.add('playing');
                } else {
                    audioPlayer.pause();
                    playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                    playPauseBtn.classList.remove('playing');
                }
            });
            
            // When audio ends
            audioPlayer.addEventListener('ended', function() {
                if (currentStepIndex < audioSteps.length - 1) {
                    loadStep(currentStepIndex + 1);
                    audioPlayer.play();
                } else {
                    playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                    playPauseBtn.classList.remove('playing');
                }
            });
            
            // Load first step initially
            if (audioSteps.length > 0) {
                loadStep(0);
            }
        });
    </script>
</body>
</html>